<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sistema Recomendador</title>
    <style>
      :root{
        --bg:#f6f7fb; --card:#ffffff; --text:#0f1724; --muted:#6b7280; --accent:#4f46e5; --success:#10b981; --danger:#ef4444;
      }
      .dark{
        --bg:#0b1220; --card:#0f1724; --text:#e6eef8; --muted:#9aa6b2; --accent:#7c3aed; --success:#34d399; --danger:#f87171;
      }
      *{box-sizing:border-box}
      body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;max-width:980px;margin:28px auto;background:var(--bg);color:var(--text);padding:18px}
      header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
      h1{font-size:20px;margin:0}
      .controls{display:flex;gap:8px;align-items:center}
      .toggle{display:flex;align-items:center;gap:8px;font-size:14px;color:var(--muted)}
      .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
      .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(9,10,15,0.06);border:1px solid rgba(15,23,36,0.04)}
      label{display:block;margin-bottom:8px;font-weight:600;color:var(--muted)}
      input{padding:10px;border-radius:8px;border:1px solid rgba(15,23,36,0.06);width:100%;background:transparent;color:var(--text)}
      .row{display:flex;gap:12px;align-items:center}
      .row button{margin-left:auto}
      .actions{margin-top:10px;text-align:right}
      .small{width:90px;min-width:60px}
      .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
      .genre-selector{display:none;margin-top:12px;padding:12px;background:var(--bg);border-radius:8px;border:1px solid rgba(15,23,36,0.1)}
      .genre-selector.visible{display:block}
      .genre-selector h3{font-size:14px;margin:0 0 8px 0;color:var(--text)}
      .genre-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}
      .genre-chip{padding:6px 12px;border-radius:16px;border:1px solid var(--accent);background:transparent;color:var(--accent);font-size:12px;cursor:pointer;transition:all 0.2s}
      .genre-chip.selected{background:var(--accent);color:white}
      .genre-chip:hover{filter:brightness(0.95)}
      button{padding:10px 12px;border-radius:8px;border:0;background:var(--accent);color:white;font-weight:600;cursor:pointer}
      button.secondary{background:var(--accent);border:0;color:white}
      button:hover{filter:brightness(0.98)}
      #output{white-space:pre-wrap;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:10px;padding:12px;border:1px solid rgba(15,23,36,0.06);min-height:120px;color:var(--text);overflow:auto}
      .meta{font-size:12px;color:var(--muted);margin-bottom:8px}
      footer{margin-top:14px;font-size:12px;color:var(--muted)}
    </style>
  </head>
  <body>
    <h1>Recomendador de Pel√≠culas - Ciencia de Datos - TP Integrador</h1>

    <header>
      <h1>Sistema Recomendador</h1>
      <div class="controls">
        <div class="toggle">
          <label for="dark-toggle">Tema oscuro</label>
          <input id="dark-toggle" type="checkbox" />
        </div>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <div class="meta">Crear usuario</div>
        <label for="create-name">Username</label>
        <div class="row">
          <input id="create-name" placeholder="Ingresar username" />
          <button id="btn-create">Crear usuario</button>
        </div>
      </div>

      <div class="card">
        <div class="meta">Buscar usuario</div>
        <label for="get-id">ID usuario</label>
        <div class="row">
          <input id="get-id" type="number" placeholder="Ingresar ID" />
          <button id="btn-get" class="secondary">Buscar</button>
        </div>
      </div>

      <div class="card">
        <div class="meta">Recomendaciones</div>
        <label for="rec-id">ID usuario</label>
        <div class="row">
          <input id="rec-id" type="number" placeholder="Ingresar ID" />
          <label for="rec-n" class="sr-only">Cantidad</label>
          <input id="rec-n" class="small" type="number" value="5" placeholder="Cantidad" aria-label="Cantidad" />
          <button id="btn-rec" class="secondary">Recomendar</button>
        </div>
        <div id="genre-selector" class="genre-selector">
          <h3>üé¨ Usuario nuevo detectado. Seleccion√° tus g√©neros favoritos:</h3>
          <div id="genre-chips" class="genre-chips"></div>
          <button id="btn-rec-genres">Recomendar con g√©neros seleccionados</button>
        </div>
      </div>

      <div class="card">
        <div class="meta">Salida / Feedback</div>
        <div id="output">Aqu√≠ aparecer√°n las respuestas...</div>
      </div>
    </div>

    <script>
      const output = document.getElementById('output')
      const root = document.documentElement
      const genreSelector = document.getElementById('genre-selector')
      const genreChips = document.getElementById('genre-chips')
      let selectedGenres = []

      function show(obj){
        const time = new Date().toLocaleTimeString()
        if(typeof obj === 'string') output.textContent = `[${time}] ${obj}`
        else output.textContent = `[${time}] ` + JSON.stringify(obj, null, 2)
      }

      function hideGenreSelector(){
        genreSelector.classList.remove('visible')
        selectedGenres = []
      }

      function showGenreSelector(genres){
        genreChips.innerHTML = ''
        selectedGenres = []
        genres.forEach(g => {
          const chip = document.createElement('button')
          chip.type = 'button'
          chip.className = 'genre-chip'
          chip.textContent = g
          chip.addEventListener('click', () => {
            if(selectedGenres.includes(g)){
              selectedGenres = selectedGenres.filter(x => x !== g)
              chip.classList.remove('selected')
            } else {
              selectedGenres.push(g)
              chip.classList.add('selected')
            }
          })
          genreChips.appendChild(chip)
        })
        genreSelector.classList.add('visible')
      }

      // Dark mode handling
      const darkToggle = document.getElementById('dark-toggle')
      function applyTheme(dark){
        if(dark) document.body.classList.add('dark')
        else document.body.classList.remove('dark')
        localStorage.setItem('dark', dark ? '1' : '0')
        darkToggle.checked = !!dark
      }
      // Initialize
      applyTheme(localStorage.getItem('dark') === '1')
      darkToggle.addEventListener('change', ()=> applyTheme(darkToggle.checked))

      async function createUser(){
        const username = document.getElementById('create-name').value.trim()
        if(!username){ show('Ingrese un username'); return }
        show('Creando usuario...')
        hideGenreSelector()
        try{
          const res = await fetch('/user', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username})})
          const text = await res.text()
          try{ const json = JSON.parse(text); show({status: res.status, body: json}); } catch(e){ show({status: res.status, body: text}) }
        }catch(e){ show('Error: '+e.message) }
      }

      async function getUser(){
        const id = document.getElementById('get-id').value
        if(!id){ show('Ingrese un id'); return }
        show('Buscando usuario...')
        hideGenreSelector()
        try{
          const res = await fetch(`/user/${encodeURIComponent(id)}`)
          if(!res.ok){ const t = await res.text(); show({status: res.status, body: t}); return }
          const json = await res.json()
          show({status: res.status, body: json})
        }catch(e){ show('Error: '+e.message) }
      }

      async function recommend(){
        const id = document.getElementById('rec-id').value
        const n = document.getElementById('rec-n').value || 5
        if(!id){ show('Ingrese un id'); return }
        show('Solicitando recomendaciones...')
        hideGenreSelector()
        try{
          const res = await fetch(`/user/${encodeURIComponent(id)}/recommend?n=${encodeURIComponent(n)}`)
          const json = await res.json()
          
          // Check if it's a new user requiring genres
          if(res.status === 400 && json.detail && json.detail.generos_disponibles){
            show('Usuario nuevo detectado. Por favor seleccion√° tus g√©neros favoritos abajo.')
            showGenreSelector(json.detail.generos_disponibles)
            return
          }
          
          show({status: res.status, body: json})
        }catch(e){ show('Error: '+e.message) }
      }

      async function recommendWithGenres(){
        const id = document.getElementById('rec-id').value
        const n = document.getElementById('rec-n').value || 5
        if(!id){ show('Ingrese un id'); return }
        if(selectedGenres.length === 0){ show('Seleccion√° al menos un g√©nero'); return }
        
        const generosParam = selectedGenres.join(',')
        show(`Solicitando recomendaciones con g√©neros: ${generosParam}...`)
        
        try{
          const res = await fetch(`/user/${encodeURIComponent(id)}/recommend?n=${encodeURIComponent(n)}&generos=${encodeURIComponent(generosParam)}`)
          const json = await res.json()
          hideGenreSelector()
          show({status: res.status, body: json})
        }catch(e){ show('Error: '+e.message) }
      }

      document.getElementById('btn-create').addEventListener('click', createUser)
      document.getElementById('btn-get').addEventListener('click', getUser)
      document.getElementById('btn-rec').addEventListener('click', recommend)
      document.getElementById('btn-rec-genres').addEventListener('click', recommendWithGenres)
    </script>
  </body>
</html>
